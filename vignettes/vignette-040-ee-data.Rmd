---
title: "vignette-040-ee-data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vignette-040-ee-data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Convert Data for Google Earth Engine App

***

`slfrsk` Google Earth Engine (EE) App <https://ieco.users.earthengine.app/view/ieco-slf-riskmap>


```{r setup, results='hide', message=FALSE}
library(slfrsk)
library(tidyverse)
library(rgdal)
library(rgeos)  #gSimplify
library(cleangeo) #clgeo_Clean
```

Call up the future data for attaching to shapefiles. Round the numeric values to reduce file size?
```{r read data}
data("states_summary_future")
data("countries_summary_future")
```

We need to transform the data to be the three properties in the correlation figures.
```{r add the corr plot data}

#states
states_summary_future <- states_summary_future %>%
  #transport in 2 mutate steps
  mutate(transport = log10_avg_infected_mass - min(log10_avg_infected_mass)) %>%
  mutate(transport = round(x = transport / max(transport), digits = 1)*10) %>%
  #establishment
  mutate(establishment = round(x = grand_mean_max, digits = 1)*10) %>%
  #impact_wine
  mutate(impact_wine = round(x = log10_avg_wine / max(log10_avg_wine), digits = 1)*10) %>%
  #impact_grape
  mutate(impact_grape = round(x = log10_avg_prod / max(log10_avg_prod), digits = 1)*10)

#countries
countries_summary_future <- countries_summary_future %>%
  #transport in 2 mutate steps
  mutate(transport = log10_avg_infected_mass - min(log10_avg_infected_mass)) %>%
  mutate(transport = round(x = transport / max(transport), digits = 1)*10) %>%
  #establishment
  mutate(establishment = round(x = grand_mean_max, digits = 1)*10) %>%
  #impact_wine
  mutate(impact_wine = round(x = log10_avg_wine / max(log10_avg_wine), digits = 1)*10) %>%
  #impact_grape
  mutate(impact_grape = round(x = log10_avg_prod / max(log10_avg_prod), digits = 1)*10)

```

We can pull country and state shapefiles from GADM
```{r read in the country and state shapefiles, message=FALSE, warning=FALSE}
  #shapefile of USA: data obtained from GADM: https://gadm.org/download_world.html
states <- readOGR(dsn = "/Volumes/GoogleDrive/Shared drives/slfRiskMapping/data/slfRisk/geo_shapefiles/gadm36_USA_shp/gadm36_USA_1.shp", verbose = F, p4s = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0')

  #shapefile of world by countries
countries <- readOGR("/Volumes/GoogleDrive/Shared drives/slfRiskMapping/data/slfRisk/geo_shapefiles/gadm36_levels_shp/gadm36_0.shp", verbose = F, p4s = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0')

```

Clean the shape data. Remove the US from the `countries` shapefile
```{r clean the shape data}
#STATES
#change DC name
#states@data$NAME_1 <- gsub(pattern = "Washington DC", replacement = "District of Columbia", x = states@data$NAME_1)

#COUNTRIES LAZY MAY WANT TO MAKE GSUB
countries@data$NAME_0[grep(pattern = "Ivoire", x = countries@data$NAME_0, value = F)] <- "Ivory Coast"
countries@data$NAME_0[grep(pattern = "ncipe", x = countries@data$NAME_0, value = F)] <- "Sao Tome and Principe"
countries@data$NAME_0[grep(pattern = "Cura", x = countries@data$NAME_0, value = F)] <- "Curacao"
countries@data$NAME_0[grep(pattern = "Saint Bart", x = countries@data$NAME_0, value = F)] <- "Saint Barthelemy"

#rm USA
countries <- countries[countries$NAME_0 != "United States",]

```

Make the shapefiles smaller.
```{r make shapefiles smaller}
#note that tol= can be modified to make the polygons simpler, larger values make the shapefile coarser
states_lo <- SpatialPolygonsDataFrame(Sr = rgeos::gSimplify(spgeom = states, topologyPreserve = TRUE, tol = 0.01), data = states@data)
countries <- SpatialPolygonsDataFrame(Sr = rgeos::gSimplify(spgeom = countries, topologyPreserve = TRUE, tol = 0.01), data = countries@data)
countries_lo <- SpatialPolygonsDataFrame(Sr = rgeos::gSimplify(spgeom = countries, topologyPreserve = TRUE, tol = 0.01), data = countries@data)

```

Filter the shapefile data to be just the states and countries in the trade data
```{r filter the states to just those in the trade data}
#states
states <- states[states@data$NAME_1 %in% unique(states_summary_future$geopol_unit),]
states_lo <- states_lo[states_lo@data$NAME_1 %in% unique(states_summary_future$geopol_unit),]
#countries
countries <- countries[countries@data$NAME_0 %in% unique(countries_summary_future$geopol_unit),]
countries_lo <- countries_lo[countries_lo@data$NAME_0 %in% unique(countries_summary_future$geopol_unit),]

```

geometries need cleaning because of scaling?
```{r make sure geometries are  clean, warning=FALSE, message=FALSE}
#check for cleaning needed?
#clgeo_SummaryReport(clgeo_CollectionReport(states))
#clgeo_SummaryReport(clgeo_CollectionReport(states_lo))
#clgeo_SummaryReport(clgeo_CollectionReport(countries))
#clgeo_SummaryReport(clgeo_CollectionReport(countries_lo))

#might as well clean them all
states <- clgeo_Clean(states)
states_lo <- clgeo_Clean(states_lo)
countries <- clgeo_Clean(countries)
countries_lo <- clgeo_Clean(countries_lo)

```

Now we can figure out how to join the trade data to the shapefiles (later to add the wine and grape production)
```{r add in the trade data}
#states
states@data <- left_join(states@data, states_summary_future, by = c("NAME_1" = "geopol_unit"))
states_lo@data <- left_join(states_lo@data, states_summary_future, by = c("NAME_1" = "geopol_unit"))
#countries
countries@data <- left_join(countries@data, countries_summary_future, by = c("NAME_0" = "geopol_unit"))
countries_lo@data <- left_join(countries_lo@data, countries_summary_future, by = c("NAME_0" = "geopol_unit"))

```

Rename the fields to accommodate for ESRI shapefile limitations
```{r rename fields}
#states
colnames(states@data)[13:35] <- c("gmean_max","gse_max","wine","grapes","avg_wine","se_wine","lavg_wine","avg_yield","se_yield","avg_prod","se_prod","lavg_yield","lavg_prod","avg_itrad","se_trad","avg_imass","se_mass","lavg_itrad","lavg_imass", "transport", "establish", "imp_wine", "imp_grape")
colnames(states_lo@data)[13:35] <- c("gmean_max","gse_max","wine","grapes","avg_wine","se_wine","lavg_wine","avg_yield","se_yield","avg_prod","se_prod","lavg_yield","lavg_prod","avg_itrad","se_trad","avg_imass","se_mass","lavg_itrad","lavg_imass", "transport", "establish", "imp_wine", "imp_grape") 
#countries
colnames(countries@data)[5:27] <- c("gmean_max","gse_max","wine","grapes","avg_wine","se_wine","lavg_wine","avg_yield","se_yield","avg_prod","se_prod","lavg_yield","lavg_prod","avg_itrad","se_trad","avg_imass","se_mass","lavg_itrad","lavg_imass", "transport", "establish", "imp_wine", "imp_grape") 
colnames(countries_lo@data)[5:27] <- c("gmean_max","gse_max","wine","grapes","avg_wine","se_wine","lavg_wine","avg_yield","se_yield","avg_prod","se_prod","lavg_yield","lavg_prod","avg_itrad","se_trad","avg_imass","se_mass","lavg_itrad","lavg_imass", "transport", "establish", "imp_wine", "imp_grape") 

```


Combine states and countries together.
```{r merge to a single shapefile, message=FALSE}
#create the combined data tables
comb <- countries@data %>%
  mutate(NAME_1 = NAME_0) %>%
  full_join(., states@data) %>%
  select(NAME_0,NAME_1,ID,status:imp_grape)
comb_lo <- countries_lo@data %>%
  mutate(NAME_1 = NAME_0) %>%
  full_join(., states_lo@data) %>%
  select(NAME_0,NAME_1,ID,status:imp_grape)

#change the data tables
#states
states@data <- comb %>% filter(NAME_0 == "United States")
states_lo@data <- comb %>% filter(NAME_0 == "United States")
#countries
countries@data <- comb %>% filter(NAME_0 != "United States")
countries_lo@data <- comb %>% filter(NAME_0 != "United States")

#final merge step
combined <- rbind(states, countries, makeUniqueIDs = TRUE)
combined_lo <- rbind(states_lo, countries_lo, makeUniqueIDs = TRUE)

```

Write out the new shapefiles (may need to rename some cols in the `@data` field, combined file should be less than 10--20 MB)
```{r write out the shapefiles, warning=FALSE, message=FALSE}
#states
writeOGR(obj = states, dsn = "/Volumes/GoogleDrive/Shared drives/slfRiskMapping/data/slfRisk/geo_shapefiles/gadm36_USA_with_data/",  driver="ESRI Shapefile", layer = "states", verbose = FALSE, overwrite_layer = TRUE)
writeOGR(obj = states_lo, dsn = "/Volumes/GoogleDrive/Shared drives/slfRiskMapping/data/slfRisk/geo_shapefiles/gadm36_USA_with_data/",  driver="ESRI Shapefile", layer = "states_lores", verbose = FALSE, overwrite_layer = TRUE)

#countries
writeOGR(obj = countries, dsn = "/Volumes/GoogleDrive/Shared drives/slfRiskMapping/data/slfRisk/geo_shapefiles/gadm36_levels_with_data/",  driver="ESRI Shapefile", layer = "countries", verbose = FALSE, overwrite_layer = TRUE)
writeOGR(obj = countries_lo, dsn = "/Volumes/GoogleDrive/Shared drives/slfRiskMapping/data/slfRisk/geo_shapefiles/gadm36_levels_with_data/",  driver="ESRI Shapefile", layer = "countries_lores", verbose = FALSE, overwrite_layer = TRUE)

#combined
writeOGR(obj = combined, dsn = "/Volumes/GoogleDrive/Shared drives/slfRiskMapping/data/slfRisk/geo_shapefiles/combined/",  driver="ESRI Shapefile", layer = "combined", verbose = FALSE, overwrite_layer = TRUE)
writeOGR(obj = combined_lo, dsn = "/Volumes/GoogleDrive/Shared drives/slfRiskMapping/data/slfRisk/geo_shapefiles/combined/",  driver="ESRI Shapefile", layer = "combined_lores", verbose = FALSE, overwrite_layer = TRUE)
```

Now we can just check to see that the data work for the shapefile!
```{r maybe test try plotting trade data, warning=FALSE}
#states_summary_present[match(x = states@data$NAME_1, table = states_summary_present$geopol_unit),]
#states@data

#states2 <- broom::tidy(states)

#fortifying to make points
states_gg <- fortify(states_lo, region = "NAME_1")
states_gg <- left_join(states_gg, states_summary_future, by = c("id" = "geopol_unit"))

#try with all
#combined_gg <- fortify(combined_lo, region = "NAME_1")
#combined_gg <- left_join(combined_gg, comb_lo, by = c("id" = "geopol_unit"))
```

```{r try to test plot}
ggplot(states_gg[!states_gg$id %in% c("Alaska", "Hawaii"),]) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = transport)) +
  coord_quickmap()
ggplot(states_gg[!states_gg$id %in% c("Alaska", "Hawaii"),]) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = establishment)) +
  coord_quickmap()
ggplot(states_gg[!states_gg$id %in% c("Alaska", "Hawaii"),]) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = impact_wine)) +
  coord_quickmap()
ggplot(states_gg[!states_gg$id %in% c("Alaska", "Hawaii"),]) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = impact_grape)) +
  coord_quickmap()
```


